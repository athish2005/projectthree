<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - Hotel Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #dff9fb, #c7ecee);
      min-height: 100vh;
    }
    .navbar { background-color: #0984e3; }
    .navbar-brand, .nav-link { color: white !important; font-weight: 600; }
    .card {
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }
    .card:hover { transform: scale(1.02); }
    section { margin-top: 30px; }
    .modal-content { border-radius: 12px; }
  </style>
</head>
<body>
  <!-- ‚úÖ Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand">üè® Hotel Booking Portal</a>
      <div class="d-flex">
        <button class="btn btn-light btn-sm me-2" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <!-- ‚úÖ Main -->
  <div class="container py-4">
    <h3 class="text-center mb-4">Welcome, <span id="userName"></span> üëã</h3>

    <!-- üîç Search -->
    <section>
      <h5>Search Hotels</h5>
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">City</label>
          <input type="text" id="citySearch" class="form-control" placeholder="Enter city name...">
        </div>
        <div class="col-md-3">
          <label class="form-label">Check-In</label>
          <input type="date" id="checkIn" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Check-Out</label>
          <input type="date" id="checkOut" class="form-control">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="searchHotels()">Search</button>
        </div>
      </div>
    </section>

    <!-- üè® Hotels -->
    <section>
      <h5 class="mt-4">Available Hotels</h5>
      <div id="hotelList" class="row gy-3"></div>
    </section>

    <!-- üìÖ Bookings -->
    <section>
      <h5 class="mt-5">Your Bookings</h5>
      <div class="table-responsive mt-3">
        <table class="table table-striped">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Hotel</th>
              <th>Room</th>
              <th>Check-In</th>
              <th>Check-Out</th>
              <th>Status</th>
              <th>Payment</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="bookingTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- üè® Booking Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Book Room</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="roomInfo"></p>
          <div class="mb-3">
            <label class="form-label">Check-In Date</label>
            <input type="date" id="modalCheckIn" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Check-Out Date</label>
            <input type="date" id="modalCheckOut" class="form-control" required>
          </div>
          <button class="btn btn-success w-100" onclick="openPaymentModal()">Proceed to Payment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üí≥ Dummy Payment Modal -->
  <div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <h5 class="mb-3">üí≥ Dummy Stripe Payment</h5>
        <p>This is a simulated payment ‚Äî no real transaction.</p>
        <input class="form-control mb-2" placeholder="Card Number">
        <input class="form-control mb-2" placeholder="MM/YY">
        <input class="form-control mb-3" placeholder="CVC">
        <button id="confirmBtn" class="btn btn-primary w-100" onclick="confirmPayment(this)">Confirm Payment</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let userEmail = "";
    let selectedRoom = null;
    let selectedRoomInfo = {};

    document.addEventListener("DOMContentLoaded", async () => {
      userEmail = localStorage.getItem("userEmail");
      const role = localStorage.getItem("userRole");
      document.getElementById("userName").textContent = localStorage.getItem("userName") || "User";

      if (role !== "USER") {
        alert("Unauthorized! Redirecting...");
        window.location.href = "/login";
        return;
      }

      await loadAllHotels();
      await loadBookings();
    });

    async function loadAllHotels() {
      const res = await fetch("/api/hotels");
      renderHotels(await res.json());
    }

    async function searchHotels() {
      const city = document.getElementById("citySearch").value.trim();
      const res = await fetch(city ? `/api/hotels/search?city=${city}` : `/api/hotels`);
      renderHotels(await res.json());
    }

    function renderHotels(hotels) {
      const list = document.getElementById("hotelList");
      list.innerHTML = hotels.length
        ? hotels.map(h => `
            <div class="col-md-4">
              <div class="card p-3">
                <h5>${h.name}</h5>
                <p><b>City:</b> ${h.city}</p>
                <button class="btn btn-success btn-sm" onclick="viewRooms(${h.id}, '${h.name}')">View Rooms</button>
              </div>
            </div>`).join('')
        : `<p class="text-muted">No hotels found.</p>`;
    }

    async function viewRooms(hotelId, hotelName) {
      const res = await fetch(`/api/rooms/hotel/${hotelId}`);
      const rooms = await res.json();

      if (!rooms.length) {
        alert("No rooms available.");
        return;
      }

      const container = document.getElementById("hotelList");
      container.innerHTML = `
        <h4>${hotelName} - Available Rooms</h4>
        ${rooms.map(r => `
          <div class="card p-3 my-2">
            <p><b>Room:</b> ${r.roomNumber}</p>
            <p><b>Type:</b> ${r.roomType}</p>
            <p><b>Price:</b> ‚Çπ${r.price}</p>
            ${r.available 
              ? `<button class='btn btn-primary btn-sm' onclick='openBookingModal(${r.id}, "${hotelName}", "${r.roomNumber}", ${r.price})'>Book Now</button>` 
              : `<span class='text-danger'>Not Available</span>`}
          </div>`).join('')}
        <button class="btn btn-secondary mt-3" onclick="loadAllHotels()">‚¨Ö Back to Hotels</button>
      `;
    }

    function openBookingModal(roomId, hotelName, roomNumber, price) {
      selectedRoom = roomId;
      selectedRoomInfo = { hotelName, roomNumber, price };
      document.getElementById("roomInfo").innerHTML = `<b>${hotelName}</b><br>Room ${roomNumber} - ‚Çπ${price}`;
      new bootstrap.Modal("#bookingModal").show();
    }

    function openPaymentModal() {
      bootstrap.Modal.getInstance(document.getElementById("bookingModal")).hide();
      new bootstrap.Modal("#paymentModal").show();
    }

   async function confirmPayment(btn) {
  try {
    btn.disabled = true;
    btn.textContent = "Processing...";

    const user = await (await fetch(`/api/users/email/${userEmail}`)).json();
    const checkIn = document.getElementById("modalCheckIn").value;
    const checkOut = document.getElementById("modalCheckOut").value;

    if (!checkIn || !checkOut) {
      alert("‚ö†Ô∏è Please select valid dates.");
      btn.disabled = false;
      btn.textContent = "Confirm Payment";
      return;
    }

    // Step 1Ô∏è‚É£: Create booking
    const bookingRes = await fetch(
      `/api/bookings?userId=${user.id}&roomId=${selectedRoom}&checkIn=${checkIn}&checkOut=${checkOut}`,
      { method: "POST" }
    );

    if (!bookingRes.ok) throw new Error("Failed to create booking");

    const booking = await bookingRes.json();
    const bookingId = booking.id;

    // Step 2Ô∏è‚É£: Create payment
    const payRes = await fetch(`/api/payments/create/${bookingId}`, { method: "POST" });
    if (!payRes.ok) throw new Error("Payment failed");

    const data = await payRes.json();
    const txnId = data.transactionId || "N/A";
    const amount = data.amount || selectedRoomInfo.price;
    const paymentStatus = (data.paymentStatus || data.status || "SUCCESS").toUpperCase();

    alert(`‚úÖ Payment ${paymentStatus}!\nTransaction ID: ${txnId}`);

    // Step 3Ô∏è‚É£: Refresh bookings immediately
    await loadBookings();

    // Step 4Ô∏è‚É£: Optional success redirect
    window.location.href = `/payment-success?hotel=${encodeURIComponent(selectedRoomInfo.hotelName)}&room=${selectedRoomInfo.roomNumber}&checkIn=${checkIn}&checkOut=${checkOut}&amount=${amount}&txnId=${txnId}`;

  } catch (err) {
    console.error("‚ùå Payment Error:", err);
    alert("Something went wrong during payment.");
  } finally {
    btn.disabled = false;
    btn.textContent = "Confirm Payment";
  }
}


    async function loadBookings() {
      const user = await (await fetch(`/api/users/email/${userEmail}`)).json();
      const res = await fetch(`/api/bookings/user/${user.id}`);
      const bookings = await res.json();
      const body = document.getElementById("bookingTableBody");
      body.innerHTML = bookings.length
        ? bookings.map(b => `
            <tr>
              <td>${b.id}</td>
              <td>${b.hotelName}</td>
              <td>${b.roomNumber}</td>
              <td>${b.checkInDate}</td>
              <td>${b.checkOutDate}</td>
              <td>${b.status}</td>
              <td>${b.paymentStatus}</td>
              <td>${b.status === "CONFIRMED" ? `<button class='btn btn-danger btn-sm' onclick='cancelBooking(${b.id})'>Cancel</button>` : "‚Äî"}</td>
            </tr>`).join('')
        : `<tr><td colspan="8" class="text-center text-muted">No bookings found.</td></tr>`;
    }

    async function cancelBooking(id) {
      if (confirm("Cancel this booking?")) {
        const res = await fetch(`/api/bookings/${id}`, { method: "DELETE" });
        res.ok ? alert("Booking cancelled!") : alert("Cancel failed!");
        loadBookings();
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "/login";
    }
  </script>
</body>
</html>
