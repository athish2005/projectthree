<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Hotel Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #ffeaa7, #fab1a0);
      min-height: 100vh;
    }
    .navbar {
      background-color: #d63031;
    }
    .navbar-brand, .nav-link {
      color: white !important;
      font-weight: 600;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    section { margin-top: 40px; }
  </style>
</head>
<body>
  <!-- âœ… Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand">ğŸ¨ Admin Dashboard</a>
      <div class="d-flex">
        <button class="btn btn-light btn-sm me-2" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <h3 class="text-center mb-4">Admin Dashboard</h3>

    <!-- âœ… Section 1: Manage Hotels -->
    <section>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>ğŸ¨ Manage Hotels</h5>
        <button class="btn btn-primary" onclick="showAddHotelForm()">â• Add New Hotel</button>
      </div>

      <div id="hotelForm" style="display:none;" class="mb-4">
        <div class="card p-3">
          <h6 id="hotelFormTitle">Add Hotel</h6>
          <input type="hidden" id="hotelId">
          <input type="text" id="hotelName" placeholder="Hotel Name" class="form-control mb-2">
          <input type="text" id="hotelCity" placeholder="City" class="form-control mb-2">
          <input type="text" id="hotelAddress" placeholder="Address" class="form-control mb-2">
          <textarea id="hotelDesc" placeholder="Description" class="form-control mb-2"></textarea>
          <button class="btn btn-success" onclick="saveHotel()">ğŸ’¾ Save</button>
          <button class="btn btn-secondary mt-2" onclick="cancelEdit()">âŒ Cancel</button>
        </div>
      </div>

      <div id="hotelList" class="row gy-3"></div>
    </section>

    <!-- âœ… Section 2: Registered Users -->
    <section>
      <h5>ğŸ‘¥ Registered Users</h5>
      <div class="table-responsive mt-3">
        <table class="table table-striped">
          <thead class="table-dark">
            <tr>
              <th>ID</th><th>Name</th><th>Email</th><th>Role</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- âœ… Section 3: Bookings & Payments -->
    <section>
      <h5>ğŸ“… Bookings & Payments</h5>
      <div class="table-responsive mt-3">
        <table class="table table-striped">
          <thead class="table-dark">
            <tr>
              <th>ID</th><th>User</th><th>Hotel</th><th>Room</th>
              <th>Check-In</th><th>Check-Out</th>
              <th>Status</th><th>Payment</th><th>Amount</th>
            </tr>
          </thead>
          <tbody id="bookingTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- âœ… View Hotel Modal -->
  <div class="modal fade" id="viewHotelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content p-4">
        <h5>ğŸ¨ Hotel Details</h5>
        <div id="hotelDetails"></div>
        <hr>
        <h6>ğŸ›ï¸ Rooms</h6>
        <div id="roomList"></div>
        <button class="btn btn-primary mt-3" onclick="showAddRoomForm()">â• Add Room</button>
      </div>
    </div>
  </div>

  <!-- âœ… Add Room Modal -->
  <div class="modal fade" id="addRoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <h5>Add New Room</h5>
        <input type="hidden" id="roomHotelId">
        <input type="text" id="roomNumber" placeholder="Room Number" class="form-control mb-2">
        <input type="text" id="roomType" placeholder="Room Type" class="form-control mb-2">
        <input type="number" id="roomPrice" placeholder="Price" class="form-control mb-2">
        <button class="btn btn-success" onclick="saveRoom()">ğŸ’¾ Save Room</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const role = localStorage.getItem("userRole");
      if (role !== "ADMIN") {
        alert("âŒ Access denied! Redirecting...");
        window.location.href = "/user-dashboard";
        return;
      }

      loadHotels();
      loadUsers();
      loadBookings();
    });

    // ---------------------------
    // HOTEL MANAGEMENT
    // ---------------------------
    async function loadHotels() {
      const res = await fetch("/api/hotels");
      const hotels = await res.json();
      const list = document.getElementById("hotelList");
      list.innerHTML = "";

      hotels.forEach(h => {
        const card = document.createElement("div");
        card.className = "col-md-4";
        card.innerHTML = `
          <div class="card p-3">
            <h5>${h.name}</h5>
            <p><b>City:</b> ${h.city}</p>
            <p><b>Address:</b> ${h.address}</p>
            <div class="d-flex justify-content-between">
              <button class="btn btn-info btn-sm" onclick="viewHotel(${h.id})">ğŸ‘ï¸ View</button>
              <button class="btn btn-warning btn-sm" onclick="editHotel(${h.id})">âœï¸ Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteHotel(${h.id})">ğŸ—‘ï¸ Delete</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    }

    async function viewHotel(id) {
      const res = await fetch(`/api/hotels/${id}`);
      const hotel = await res.json();

      document.getElementById("hotelDetails").innerHTML = `
        <p><b>Name:</b> ${hotel.name}</p>
        <p><b>City:</b> ${hotel.city}</p>
        <p><b>Address:</b> ${hotel.address}</p>
        <p><b>Description:</b> ${hotel.description}</p>
      `;

      document.getElementById("roomHotelId").value = hotel.id;

      const roomRes = await fetch(`/api/rooms/hotel/${hotel.id}`);
      const rooms = await roomRes.json();
      const roomList = document.getElementById("roomList");
      roomList.innerHTML = rooms.length
        ? rooms.map(r => `<p>Room ${r.roomNumber} - ${r.roomType} - â‚¹${r.price} (${r.available ? "Available" : "Booked"})</p>`).join("")
        : "<p class='text-muted'>No rooms found.</p>";

      new bootstrap.Modal("#viewHotelModal").show();
    }

    function showAddHotelForm() {
      document.getElementById("hotelForm").style.display = "block";
      document.getElementById("hotelFormTitle").textContent = "Add Hotel";
      document.getElementById("hotelId").value = "";
      clearForm();
    }

    function clearForm() {
      ["hotelName","hotelCity","hotelAddress","hotelDesc"].forEach(id => document.getElementById(id).value = "");
    }

    function cancelEdit() {
      document.getElementById("hotelForm").style.display = "none";
    }

    async function saveHotel() {
      const id = document.getElementById("hotelId").value;
      const hotel = {
        name: document.getElementById("hotelName").value.trim(),
        city: document.getElementById("hotelCity").value.trim(),
        address: document.getElementById("hotelAddress").value.trim(),
        description: document.getElementById("hotelDesc").value.trim()
      };

      const method = id ? "PUT" : "POST";
      const url = id ? `/api/hotels/${id}` : "/api/hotels";
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(hotel)
      });

      if (res.ok) {
        alert("âœ… Hotel saved successfully");
        cancelEdit();
        loadHotels();

        if (!id) {
          const savedHotel = await res.json();
          viewHotel(savedHotel.id); // immediately show modal for room addition
        }
      } else {
        alert("âŒ Failed to save hotel");
      }
    }

    async function editHotel(id) {
      const res = await fetch(`/api/hotels/${id}`);
      const h = await res.json();
      document.getElementById("hotelForm").style.display = "block";
      document.getElementById("hotelFormTitle").textContent = "Edit Hotel";
      document.getElementById("hotelId").value = h.id;
      document.getElementById("hotelName").value = h.name;
      document.getElementById("hotelCity").value = h.city;
      document.getElementById("hotelAddress").value = h.address;
      document.getElementById("hotelDesc").value = h.description;
    }

    async function deleteHotel(id) {
      if (!confirm("Are you sure you want to delete this hotel?")) return;
      await fetch(`/api/hotels/${id}`, { method: "DELETE" });
      alert("ğŸ—‘ï¸ Hotel deleted");
      loadHotels();
    }

    // ---------------------------
    // ADD ROOM LOGIC
    // ---------------------------
    function showAddRoomForm() {
      new bootstrap.Modal("#addRoomModal").show();
    }

    async function saveRoom() {
      const hotelId = document.getElementById("roomHotelId").value;
      const room = {
        roomNumber: document.getElementById("roomNumber").value.trim(),
        roomType: document.getElementById("roomType").value.trim(),
        price: parseFloat(document.getElementById("roomPrice").value)
      };

      const res = await fetch(`/api/rooms/hotel/${hotelId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(room)
      });

      if (res.ok) {
        alert("âœ… Room added successfully!");
        bootstrap.Modal.getInstance(document.getElementById("addRoomModal")).hide();
        viewHotel(hotelId);
      } else {
        alert("âŒ Failed to add room.");
      }
    }

    // ---------------------------
    // USERS & BOOKINGS
    // ---------------------------
    async function loadUsers() {
      const res = await fetch("/api/users");
      const users = await res.json();
      document.getElementById("userTableBody").innerHTML = users.map(u =>
        `<tr><td>${u.id}</td><td>${u.name}</td><td>${u.email}</td><td>${u.role}</td></tr>`
      ).join("");
    }

   async function loadBookings() {
  const res = await fetch("/api/bookings");
  if (!res.ok) return;
  const bookings = await res.json();

  document.getElementById("bookingTableBody").innerHTML = bookings.map(b => `
    <tr>
      <td>${b.id ?? "N/A"}</td>
      <td>${b.userEmail || "Unknown"}</td>
      <td>${b.hotelName || "N/A"}</td>
      <td>${b.roomNumber || "N/A"}</td>
      <td>${b.checkInDate || "N/A"}</td>
      <td>${b.checkOutDate || "N/A"}</td>
      <td>${b.status || "N/A"}</td>
      <td>${b.paymentStatus || "N/A"}</td>
      <td>${b.amount ?? 0}</td>
    </tr>
  `).join("");
}


    function logout() {
      localStorage.clear();
      window.location.href = "/login";
    }
  </script>
</body>
</html>
